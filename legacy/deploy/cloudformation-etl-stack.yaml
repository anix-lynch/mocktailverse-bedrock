AWSTemplateFormatVersion: '2010-09-09'
Description: 'Mocktailverse ETL Pipeline - Free Tier Compliant Infrastructure'

Parameters:
  KeyPairName:
    Type: String
    Description: EC2 KeyPair for SSH access (optional)
    Default: ''

Resources:
  # ========================================
  # S3 Buckets (5GB Free Tier)
  # ========================================
  RawDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'mocktailverse-raw-data-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldRawData
            Status: Enabled
            ExpirationInDays: 30

  ProcessedDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'mocktailverse-processed-data-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldProcessedData
            Status: Enabled
            ExpirationInDays: 60

  ScriptsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'mocktailverse-scripts-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ========================================
  # DynamoDB Table (25GB + 200M requests/month Free)
  # ========================================
  CocktailsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: mocktailverse-cocktails
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: category
          AttributeType: S
        - AttributeName: spirit_type
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: category-index
          KeySchema:
            - AttributeName: category
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
        - IndexName: spirit-type-index
          KeySchema:
            - AttributeName: spirit_type
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
      Tags:
        - Key: Project
          Value: Mocktailverse
        - Key: Environment
          Value: Production

  ProcessingSummaryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: mocktailverse-processing-summary
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      AttributeDefinitions:
        - AttributeName: date_partition
          AttributeType: S
      KeySchema:
        - AttributeName: date_partition
          KeyType: HASH
      Tags:
        - Key: Project
          Value: Mocktailverse

  # ========================================
  # IAM Roles
  # ========================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: mocktailverse-lambda-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub '${RawDataBucket.Arn}/*'
                  - !Sub '${ProcessedDataBucket.Arn}/*'
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt CocktailsTable.Arn
                  - !GetAtt ProcessingSummaryTable.Arn

  GlueServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: mocktailverse-glue-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub '${RawDataBucket.Arn}/*'
                  - !Sub '${ProcessedDataBucket.Arn}/*'
                  - !Sub '${ScriptsBucket.Arn}/*'

  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: mocktailverse-ec2-airflow-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
        - arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess
        - arn:aws:iam::aws:policy/AWSLambda_FullAccess

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: mocktailverse-ec2-profile
      Roles:
        - !Ref EC2Role

  # ========================================
  # Lambda Function for Data Enrichment
  # ========================================
  TransformLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: mocktailverse-transform-lambda
      Runtime: python3.11
      Handler: transform.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          INPUT_BUCKET: !Ref ProcessedDataBucket
          OUTPUT_BUCKET: !Ref ProcessedDataBucket
          DYNAMODB_TABLE: !Ref CocktailsTable
      Code:
        ZipFile: |
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Placeholder - Deploy from repo')}

  # ========================================
  # EC2 Instance for Airflow (t2.micro Free Tier)
  # ========================================
  AirflowSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: mocktailverse-airflow-sg
      GroupDescription: Security group for Airflow EC2 instance
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: mocktailverse-airflow-sg

  AirflowInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !Ref AirflowSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          yum update -y
          
          # Install Python 3.11
          yum install -y python3.11 python3.11-pip git
          
          # Install Docker
          yum install -y docker
          systemctl start docker
          systemctl enable docker
          usermod -a -G docker ec2-user
          
          # Set environment variables
          export AIRFLOW_HOME=/opt/airflow
          export AIRFLOW__CORE__LOAD_EXAMPLES=False
          
          # Create directory
          mkdir -p $AIRFLOW_HOME
          
          # Install Airflow
          pip3.11 install apache-airflow[aws]==2.7.3
          pip3.11 install boto3 apache-airflow-providers-amazon
          
          # Clone repository
          cd /opt
          git clone https://github.com/anix-lynch/mocktailverse.git
          
          # Copy DAG files
          cp -r /opt/mocktailverse/dags/* $AIRFLOW_HOME/dags/ || mkdir -p $AIRFLOW_HOME/dags
          cp /opt/mocktailverse/airflow_dag.py $AIRFLOW_HOME/dags/
          
          # Initialize Airflow
          airflow db init
          
          # Create admin user
          airflow users create \
            --username admin \
            --firstname Admin \
            --lastname User \
            --role Admin \
            --email admin@example.com \
            --password admin
          
          # Start Airflow webserver and scheduler
          airflow webserver -D
          airflow scheduler -D
          
      Tags:
        - Key: Name
          Value: mocktailverse-airflow
        - Key: Project
          Value: Mocktailverse

  # ========================================
  # Glue Job Definition
  # ========================================
  GlueJob:
    Type: AWS::Glue::Job
    Properties:
      Name: mocktailverse-etl-transform
      Role: !GetAtt GlueServiceRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${ScriptsBucket}/glue/transform_cocktail_data.py'
        PythonVersion: '3'
      DefaultArguments:
        '--job-bookmark-option': 'job-bookmark-enable'
        '--enable-metrics': ''
        '--input_bucket': !Ref RawDataBucket
        '--output_bucket': !Ref ProcessedDataBucket
      MaxRetries: 1
      Timeout: 60
      GlueVersion: '3.0'
      MaxCapacity: 2

Outputs:
  AirflowURL:
    Description: Airflow Web UI URL
    Value: !Sub 'http://${AirflowInstance.PublicIp}:8080'
  
  RawDataBucketName:
    Description: S3 bucket for raw data
    Value: !Ref RawDataBucket
  
  ProcessedDataBucketName:
    Description: S3 bucket for processed data
    Value: !Ref ProcessedDataBucket
  
  DynamoDBTableName:
    Description: DynamoDB table for cocktails
    Value: !Ref CocktailsTable
  
  LambdaFunctionName:
    Description: Lambda function for data transformation
    Value: !Ref TransformLambda
  
  EC2PublicIP:
    Description: Public IP of Airflow EC2 instance
    Value: !GetAtt AirflowInstance.PublicIp
